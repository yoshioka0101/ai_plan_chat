# CLAUDE.md

This document serves as a guide for AI development assistants (Claude) to understand and work efficiently with this project.

## Project Overview

AI Plan Chat is a web application built with a Clean Architecture approach, featuring a Golang backend in a monorepo structure.

## Tech Stack

### Backend
- **Language**: Go 1.25
- **Framework**: Gin (v1.10.1)
- **Architecture**: Clean Architecture
- **Query Builder**: BOB (type-safe SQL query builder)
- **API Specification**: OpenAPI 3.0
- **Validation**: go-playground/validator v10
- **Testing**: Standard `testing` package + testify (unit tests implemented)

### Frontend
- Not yet implemented
- Tests not yet written

## Repository Structure

```
.
├── backend/
│   ├── cmd/              # Application entry points
│   ├── internal/
│   │   ├── api/          # API specifications
│   │   │   └── openapi/  # OpenAPI definition files
│   │   ├── database/     # Database layer
│   │   │   └── queries/  # SQL queries (BOB)
│   │   ├── gen/          # Generated code
│   │   │   └── api/      # API types generated by oapi-codegen
│   │   ├── http/
│   │   │   ├── handler/  # HTTP handlers
│   │   │   └── routes.go # Route definitions
│   │   ├── middleware/   # Middleware
│   │   └── models/       # Domain models
│   ├── schemas/          # Database schemas
│   ├── bin/              # Build artifacts
│   ├── go.mod
│   ├── go.sum
│   └── Makefile
├── migrations/           # Database migrations
└── README.md
```

## Architecture Principles

This project follows Clean Architecture:

### Layer Separation
1. **HTTP Layer** (`handler/`): Handles HTTP requests/responses
2. **Domain Layer** (`models/`): Business logic and entities
3. **Data Layer** (`database/`): Data access using BOB

### Dependency Rule
- Dependencies point inward only
- Inner layers should not depend on outer layers
- Domain layer remains independent

## Development Guidelines

### Coding Standards

#### Go Code
- Follow standard Go naming conventions
- Use `gofmt` for formatting
- Explicit error handling
- Proper context propagation
- Type safety with BOB query builder

#### API Design
- OpenAPI specification as the source of truth
- API definitions in `backend/internal/api/openapi/`
- Generate code with `make generate`
- View API docs with `make redoc`

### Testing Strategy

#### Backend
- **Status**: Unit tests implemented
- **Location**: `*_test.go` files
- **Framework**: Go standard `testing` + testify
- **Run**: `go test ./...`

#### Frontend
- **Status**: Not yet implemented
- Tests need to be written when frontend is developed

### BOB Query Builder Usage

BOB provides type-safe SQL query building:

```go
// Place queries in backend/internal/database/queries/
// Leverage BOB's type safety for compile-time query validation
// Avoid raw SQL strings; use BOB's fluent API
```

### Development Workflow

1. **Update API Specification**
   ```bash
   cd backend
   # Edit OpenAPI files in internal/api/openapi/
   make generate  # Generate Go types and interfaces
   ```

2. **Start Development Server**
   ```bash
   cd backend
   make run  # Or use air for hot reload
   ```

3. **Run Tests**
   ```bash
   cd backend
   go test ./...
   ```

4. **View API Documentation**
   ```bash
   cd backend
   make redoc
   # Open browser to http://localhost:8080
   ```

## Implementation Patterns

### Handler Implementation
```go
// backend/internal/http/handler/
// 1. Interfaces generated from OpenAPI spec
// 2. Implement interfaces in handlers
// 3. Keep domain logic in models/
// 4. Use dependency injection for testability
```

### Error Handling
- Use appropriate HTTP status codes
- Return consistent error response format
- Log errors with context
- Don't expose internal errors to clients

### Middleware
- Logger: `internal/middleware/logger.go`
- Implement cross-cutting concerns (auth, logging, etc.) as middleware
- Keep handlers focused on business logic

## API Documentation

- **Definition**: `backend/internal/api/openapi/openapi.yaml`
- **Online**: https://yoshioka0101.github.io/ai_plan_chat/
- **Local**: Run `make redoc` in backend directory

## Makefile Commands

```bash
make generate  # Generate code from OpenAPI spec
make run       # Start application
make redoc     # View API docs in browser
make test      # Run tests
```

## Important Notes

### Current State
- Backend unit tests are implemented
- Frontend is not yet implemented
- Frontend tests are not yet written
- This is a monorepo structure

### When Making Changes
1. Ensure OpenAPI spec consistency
2. Follow Clean Architecture principles
3. Implement proper error handling
4. Run and update existing tests
5. Maintain backward compatibility where possible

### BOB Query Builder
- Prefer BOB over raw SQL for type safety
- Keep queries in `database/queries/`
- Use BOB's transaction support when needed

## Common Tasks

### Adding a New Endpoint
1. Define endpoint in OpenAPI spec (`internal/api/openapi/`)
2. Run `make generate` to generate interfaces
3. Implement handler in `internal/http/handler/`
4. Add route in `internal/http/routes.go`
5. Write unit tests
6. Update this documentation if needed

### Adding Database Operations
1. Create query using BOB in `internal/database/queries/`
2. Implement repository interface if needed
3. Write unit tests with mocked database
4. Handle errors appropriately

### Adding Middleware
1. Create middleware in `internal/middleware/`
2. Register in route setup (`internal/http/routes.go`)
3. Ensure proper request/response handling
4. Add tests

## Resources

- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Gin Web Framework](https://gin-gonic.com/)
- [OpenAPI Specification](https://swagger.io/specification/)
- [BOB Query Builder](https://github.com/stephenafamo/bob)
- [Go Testing](https://go.dev/doc/tutorial/add-a-test)
