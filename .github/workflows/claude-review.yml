name: Claude Code Review

on:
  push:
    branches:
      - main
      - v1.*
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  id-token: write
  issues: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Code Review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            このプルリクエストを以下の観点でレビューして、PRのコメントスレッドに詳細なフィードバックを投稿してください。

            ## レビュー観点

            ### 1. コードの品質 ⭐
            - コードが適切に構造化されているか
            - ベストプラクティスに従っているか
            - 不要な複雑さがないか

            ### 2. コードの可読性 ⭐
            - 変数名、関数名が適切か
            - コメントが必要な箇所に記載されているか
            - コードの意図が明確か

            ### 3. コードの保守性 ⭐
            - 変更が容易か
            - モジュール化されているか
            - 依存関係が適切か

            ### 4. コードの拡張性 ⭐
            - 将来の機能追加に対応しやすいか
            - 設計が柔軟か

            ### 5. コードのテスト ⭐
            - テストが適切に記載されているか
            - エッジケースが考慮されているか
            - テストカバレッジは十分か

            ### 6. コードのパフォーマンス ⭐
            - パフォーマンスの問題がないか
            - リソース使用が適切か

            ### 7. コードのセキュリティ ⭐
            - セキュリティの脆弱性がないか
            - 入力検証が適切か
            - 認証・認可が適切か

            ## フィードバック形式

            各観点について以下の形式でフィードバックしてください：

            - **具体的な改善案**を提示（ファイル名:行番号を明記）
            - **優先度**を明示（🔴 Critical / 🟡 Medium / 🟢 Low）
            - **コード例**を含める
            - **総合評価**を5段階で表示（⭐⭐⭐⭐⭐）

            最後に「✅ マージ前に対応すべき項目」と「📝 今後の改善提案」をまとめてください。
          use_sticky_comment: true