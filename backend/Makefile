.PHONY: help lint fmt test dev build openapi-gen gen-api gen-db openapi redoc install dev-full test-db migrate

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ - ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
help:
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo "  install å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  dev         é–‹ç™ºç’°å¢ƒã®ç«‹ã¡ä¸Šã’"
	@echo "  test        ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ"
	@echo "  lint        ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ"
	@echo "  fmt         ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
	@echo "  build       ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰"
	@echo "  gen-api     OpenAPIã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ"
	@echo "  gen-db      ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰Goå‹ã‚’ç”Ÿæˆ"
	@echo "  redoc       ReDoc ã§OpenAPIä»•æ§˜ã‚’ç¢ºèª"
	@echo "  bundle      OpenAPIãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆ"
	@echo "  dev-full    ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ + ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ + é–‹ç™ºã‚µãƒ¼ãƒãƒ¼"
	@echo "  openapi-gen OpenAPIã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆå¾“æ¥ç‰ˆï¼‰"
	@echo "  openapi     ReDoc ã‚’èµ·å‹•ï¼ˆredoc ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰"
	@echo "  ci          GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é››å½¢ã‚’ã‚³ãƒ”ãƒ¼"
	@echo "  test-db     ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ"
	@echo "  migrate     ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"
	@echo "  help        ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"

# å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	@echo "é–‹ç™ºã«å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
	@echo "Go ãƒ„ãƒ¼ãƒ«:"
	go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest
	go install github.com/air-verse/air@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "Node.js ãƒ„ãƒ¼ãƒ«:"
	npm install -g http-server
	npm install -g @redocly/cli
	@echo ""
	@echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
	@echo "ä½¿ã„æ–¹: make gen-api â†’ make gen-db â†’ make redoc â†’ make dev"

# é–‹ç™ºç’°å¢ƒã®ç«‹ã¡ä¸Šã’
dev:
	@echo "é–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ã—ã¦ã„ã¾ã™"
	@export PATH=$$PATH:$$(go env GOPATH)/bin && air

# ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
test:
	@echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™"
	go test -v ./...

# ã‚³ãƒ¼ãƒ‰ã®é™çš„è§£æ
lint:
	@echo "ã‚³ãƒ¼ãƒ‰ã® lint ã‚’ã—ã¾ã™s"
	./bin/golangci-lint run

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
fmt:
	@echo "ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦ã„ã¾ã™"
	go fmt ./...

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
build:
	@echo "ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™"
	go build -o bin/api cmd/api/main.go
	@echo "ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ: bin/api"

.PHONY: redocly-bundle
redocly-bundle: # redocly ã§ OpenAPI ã‚’å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã™ã‚‹
	@npx @redocly/cli@1.34.2 bundle internal/api/openapi/openapi.yaml -o internal/api/openapi/openapi-bundle.yaml

.PHONY: redocly-split
redocly-split: # redocly ã§ OpenAPI ã‚’è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã™ã‚‹
	@npx @redocly/cli@1.34.2 split internal/api/openapi-bundle.yaml --outDir internal/api/schemas

.PHONY: gen-api
gen-api: redocly-bundle ## ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆoapi-codegenï¼‰
	@cd internal/api/openapi && go run github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen --config=./oapi-codegen.yaml ./openapi-bundle.yaml
	@go mod tidy

.PHONY: gen-db
gen-db: ## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰Goå‹ã‚’ç”Ÿæˆï¼ˆbobgenï¼‰
	@echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰Goå‹ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™"
	@echo "DB_DSNç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™"
	@bobgen mysql -c bobgen.yaml
	@go mod tidy
	@echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‹ç”Ÿæˆå®Œäº†: internal/gen/db"

# OpenAPIã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆå¾“æ¥ç‰ˆï¼‰
openapi-gen:
	@echo "OpenAPIã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™"
	@cd internal/api && oapi-codegen --config=./oapi-codegen.yaml ./openapi.yaml

.PHONY: redoc
redoc: ## redoc ã‚’èµ·å‹•ã™ã‚‹
	npx @redocly/cli@1.34.2 preview-docs -p 3001 internal/api/openapi/openapi.yaml


# é–‹ç™ºç”¨çµ±åˆã‚³ãƒãƒ³ãƒ‰
dev-full:
	@echo "çµ±åˆé–‹ç™ºç’°å¢ƒã‚’èµ·å‹•ä¸­..."
	@$(MAKE) --no-print-directory gen-api
	@$(MAKE) --no-print-directory gen-db
	@echo "APIã‚µãƒ¼ãƒãƒ¼: http://localhost:8080"
	@echo "ReDoc: åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ 'make redoc' ã‚’å®Ÿè¡Œ"
	@$(MAKE) --no-print-directory dev

# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é››å½¢ã‚³ãƒ”ãƒ¼
ci:
	@if [ -z "$(FILENAME)" ]; then \
		echo "FILENAME ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¾‹: make ci FILENAME=deploy"; \
		exit 1; \
	fi
	@mkdir -p ../.github/workflows
	@if [ -f ../.github/workflows/$(FILENAME).yml ]; then \
		echo "../.github/workflows/$(FILENAME).yml ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
		exit 1; \
	fi
	cp ../.github/workflows/ci.yml.example ../.github/workflows/$(FILENAME).yml
	@echo ".github/workflows/$(FILENAME).yml ã‚’ä½œæˆã—ã¾ã—ãŸ"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
test-db:
	@echo "ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
	@go run cmd/test-db/test-db.go

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
migrate:
	@echo "ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œä¸­..."
	@go run cmd/migrate/migrate.go